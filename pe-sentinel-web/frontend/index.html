<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE-Sentinel | Advanced Malware Analysis</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>
    
    <style>
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #6366f1;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-card-alt: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-soft: #e2e8f0;
            --radius: 12px;
            --shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-card-alt: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-soft: #334155;
            --shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }
        
        .navbar { 
            background: var(--bg-card) !important; 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border-soft); 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            transition: background 0.3s;
        }
        .navbar-brand { font-weight: 700; color: var(--brand-primary) !important; }
        .nav-link { color: var(--text-muted); font-weight: 500; font-size: 0.9rem; }
        .nav-link:hover, .nav-link.active { color: var(--brand-primary); }
        
        .card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-soft); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 20px;
            transition: background 0.3s, border 0.3s;
        }
        .card-header { 
            background: transparent; 
            border-bottom: 1px solid var(--border-soft); 
            padding: 16px 20px; 
            font-weight: 600;
            color: var(--text-main);
        }
        .card-body { color: var(--text-main); }
        
        .upload-zone { 
            border: 2px dashed var(--border-soft); 
            border-radius: 16px; 
            padding: 50px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s;
            background: var(--bg-card);
        }
        .upload-zone:hover { border-color: var(--brand-primary); background: rgba(79, 70, 229, 0.05); }
        .upload-icon { 
            width: 64px; height: 64px; 
            background: rgba(79, 70, 229, 0.1); 
            color: var(--brand-primary); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 20px; 
            font-size: 1.5rem; 
        }
        
        .threat-score-card { 
            background: var(--bg-card); 
            padding: 20px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border-soft); 
            text-align: center; 
            flex: 1;
            transition: background 0.3s;
        }
        .score-value { font-size: 2.5rem; font-weight: 800; line-height: 1; color: var(--text-main); }
        .threat-badge { background: var(--bg-card-alt); padding: 4px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        
        .data-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .data-value { font-weight: 600; color: var(--text-main); }
        
        .adv-tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .adv-tab { 
            padding: 8px 16px; 
            border: 1px solid var(--border-soft); 
            border-radius: 8px; 
            background: var(--bg-card); 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 500; 
            transition: all 0.2s;
            color: var(--text-main);
        }
        .adv-tab:hover { background: var(--bg-card-alt); }
        .adv-tab.active { background: var(--brand-primary); color: white; border-color: var(--brand-primary); }
        .adv-tab.disabled { opacity: 0.5; pointer-events: none; }
        
        .adv-panel { display: none; padding: 20px; background: var(--bg-card-alt); border-radius: 8px; }
        .adv-panel.active { display: block; }
        .adv-panel h6 { color: var(--text-main); }
        
        .search-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .search-row input, .search-row select { 
            border: 1px solid var(--border-soft); 
            border-radius: 8px; 
            padding: 8px 12px;
            background: var(--bg-card);
            color: var(--text-main);
        }
        .search-row input:focus, .search-row select:focus { outline: none; border-color: var(--brand-primary); }
        .search-row input::placeholder { color: var(--text-muted); }
        
        #analysisLog { 
            background: #1e293b !important; 
            color: #94a3b8; 
            border-radius: 8px; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.8rem; 
            padding: 16px; 
            max-height: 200px; 
            overflow-y: auto; 
        }
        
        .section-table { color: var(--text-main); }
        .section-table thead th { 
            background: var(--bg-card-alt); 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-soft);
        }
        .section-table td { border-bottom: 1px solid var(--border-soft); }
        
        .btn-primary { background: var(--brand-primary); border: none; }
        .btn-primary:hover { background: #4338ca; }
        .btn-outline-secondary { 
            border-color: var(--border-soft); 
            color: var(--text-main); 
        }
        .btn-outline-secondary:hover { 
            background: var(--bg-card-alt); 
            color: var(--text-main);
            border-color: var(--border-soft);
        }
        
        .table { color: var(--text-main); }
        .table-responsive { border-radius: 0 0 var(--radius) var(--radius); }
        
        .alert { color: var(--text-main); }
        
        /* Dark mode toggle */
        .theme-toggle {
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-main);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--brand-primary); color: white; }
        
        #yaraRules { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            min-height: 200px; 
            background: #1e293b; 
            color: #e2e8f0; 
            border: none; 
            border-radius: 8px; 
            padding: 12px; 
            width: 100%; 
        }
        #yaraRules::placeholder { color: #64748b; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Import Analysis Card */
        .import-alert {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
        }
        .import-alert.warning {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: #ffc107;
        }
        .import-alert.info {
            background: rgba(23, 162, 184, 0.1);
            border-left-color: #17a2b8;
        }
        
        footer {
            background: var(--bg-card);
            border-top: 1px solid var(--border-soft);
            transition: background 0.3s;
        }
        footer a { color: var(--text-muted); text-decoration: none; }
        footer a:hover { color: var(--brand-primary); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/home"><i class="fas fa-shield-halved me-2"></i>PE-SENTINEL</a>
            <div class="d-flex align-items-center gap-3">
                <a href="/home" class="nav-link">Home</a>
                <a href="/docs" class="nav-link">Docs</a>
                <a href="/" class="nav-link active">Analyzer</a>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <span class="badge bg-primary">v2.2</span>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="text-center py-4">
            <h1 class="display-6 fw-bold">Binary Analysis Platform</h1>
            <p class="text-muted">Advanced static analysis with Rich Header, Import Density & MITRE mapping</p>
        </div>

        <div class="upload-zone mb-4" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <h5 class="fw-bold mb-1">Drop PE file here</h5>
            <p class="text-muted small mb-0">.exe, .dll, .sys up to 50MB</p>
            <input type="file" id="fileInput" accept=".exe,.dll,.sys" style="display:none;">
        </div>

        <div id="loading" style="display:none;" class="mb-4">
            <div class="card p-4 text-center">
                <div class="spinner-grow text-primary mb-3"></div>
                <h6 class="fw-bold">Analyzing...</h6>
                <div class="progress mt-3 mx-auto" style="height:6px; width:250px;">
                    <div class="progress-bar" id="progressBar" style="width:0%; background:var(--brand-primary);"></div>
                </div>
            </div>
        </div>

        <div id="results">
            <!-- Quick Stats -->
            <div class="alert bg-white border mb-4" id="quickStats" style="display:none; border-left:4px solid var(--brand-primary) !important;">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span class="small fw-bold"><i class="fas fa-check-circle text-success me-2"></i>Analysis Complete</span>
                    <div class="d-flex gap-4">
                        <div><div class="data-label">Arch</div><div id="quickArch" class="small fw-bold">-</div></div>
                        <div><div class="data-label">Size</div><div id="quickSize" class="small fw-bold">-</div></div>
                        <div><div class="data-label">Signed</div><div id="quickSigned" class="small fw-bold">-</div></div>
                        <div><div class="data-label">Compiler</div><div id="quickCompiler" class="small fw-bold">-</div></div>
                    </div>
                </div>
            </div>

            <!-- File Info -->
            <div class="card">
                <div class="card-header">File Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3"><div class="data-label">Filename</div><div id="filename" class="data-value text-truncate">-</div></div>
                        <div class="col-md-2"><div class="data-label">Architecture</div><div id="architecture" class="data-value">-</div></div>
                        <div class="col-md-3"><div class="data-label">Entry Point</div><code id="entrypoint">-</code></div>
                        <div class="col-md-2"><div class="data-label">Signed</div><div id="signed" class="data-value">-</div></div>
                        <div class="col-md-2"><div class="data-label">Size</div><div id="filesize" class="data-value">-</div></div>
                    </div>
                    <div class="mt-2 pt-2 border-top"><small class="text-muted">Analyzed: <span id="timestamp">-</span></small></div>
                </div>
            </div>

            <!-- Scores -->
            <div class="d-flex gap-3 mb-4 flex-wrap">
                <div class="threat-score-card"><div class="data-label">Structural</div><div class="score-value" id="structuralScore">0</div></div>
                <div class="threat-score-card"><div class="data-label">Behavioral</div><div class="score-value" id="behavioralScore">0</div></div>
                <div class="threat-score-card" style="border-top:4px solid var(--brand-primary);"><div class="data-label">Overall</div><div class="score-value" id="overallScore">0</div><span class="threat-badge" id="threatBadge">-</span></div>
            </div>

            <!-- Rich Header Analysis (NEW) -->
            <div class="card" id="richHeaderCard" style="display:none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-fingerprint me-2"></i>Rich Header Analysis</span>
                    <span class="badge bg-info" id="richBadge">-</span>
                </div>
                <div class="card-body" id="richHeaderContent"></div>
            </div>

            <!-- Import Analysis (Informational) -->
            <div class="card" id="importDensityCard" style="display:none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-boxes me-2"></i>Import Analysis</span>
                    <span class="badge" id="densityBadge">-</span>
                </div>
                <div class="card-body" id="importDensityContent"></div>
            </div>

            <!-- Advanced Panel -->
            <div class="card" id="advancedPanel" style="display:none;">
                <div class="card-header"><i class="fas fa-microscope me-2"></i>Advanced Analysis <span class="badge bg-success ms-2">Interactive</span></div>
                <div class="card-body">
                    <div class="adv-tabs">
                        <div class="adv-tab active" data-target="panelFunctions"><i class="fas fa-code me-1"></i>Functions</div>
                        <div class="adv-tab" data-target="panelStrings"><i class="fas fa-font me-1"></i>Strings</div>
                        <div class="adv-tab" data-target="panelYara" id="yaraTab"><i class="fas fa-shield-alt me-1"></i>YARA</div>
                        <div class="adv-tab" data-target="panelSections"><i class="fas fa-layer-group me-1"></i>Sections</div>
                        <div class="adv-tab" data-target="panelIocs"><i class="fas fa-crosshairs me-1"></i>IOCs</div>
                        <div class="adv-tab" data-target="panelHex"><i class="fas fa-th me-1"></i>Hex</div>
                    </div>

                    <div class="adv-panel active" id="panelFunctions">
                        <h6><i class="fas fa-search me-2"></i>Search Imports & Exports</h6>
                        <div class="search-row">
                            <input type="text" id="functionQuery" placeholder="e.g. CreateRemote, VirtualAlloc" style="flex:1;">
                            <select id="functionSearchType"><option value="contains">Contains</option><option value="exact">Exact</option><option value="regex">Regex</option></select>
                            <label class="d-flex align-items-center gap-2"><input type="checkbox" id="includeExports" checked> Exports</label>
                            <button class="btn btn-primary btn-sm" id="searchFunctionsBtn"><i class="fas fa-search me-1"></i>Search</button>
                        </div>
                        <div id="functionResults" class="mt-3"><p class="text-muted small">Search for APIs. High-risk functions are highlighted ⚠️</p></div>
                    </div>

                    <div class="adv-panel" id="panelStrings">
                        <h6><i class="fas fa-search me-2"></i>Search Strings</h6>
                        <div class="search-row">
                            <input type="text" id="stringQuery" placeholder="e.g. http://, password, cmd.exe" style="flex:1;">
                            <select id="stringSearchType"><option value="contains">Contains</option><option value="regex">Regex</option></select>
                            <input type="number" id="stringMinLength" value="4" min="1" max="50" style="width:80px;" title="Min length">
                            <button class="btn btn-primary btn-sm" id="searchStringsBtn"><i class="fas fa-search me-1"></i>Search</button>
                        </div>
                        <div id="stringResults" class="mt-3"><p class="text-muted small">Search strings. URLs, paths, registry keys are tagged.</p></div>
                    </div>

                    <div class="adv-panel" id="panelYara">
                        <h6><i class="fas fa-shield-alt me-2"></i>Custom YARA Rules</h6>
                        <textarea id="yaraRules" class="form-control mb-3" placeholder="rule example {
    meta:
        description = &quot;My rule&quot;
    strings:
        $mz = &quot;MZ&quot;
        $s1 = &quot;malware&quot; nocase
    condition:
        $mz at 0 and $s1
}"></textarea>
                        <button class="btn btn-danger btn-sm" id="runYaraBtn"><i class="fas fa-play me-1"></i>Run YARA Scan</button>
                        <div id="yaraResults" class="mt-3"></div>
                    </div>

                    <div class="adv-panel" id="panelSections">
                        <h6><i class="fas fa-filter me-2"></i>Filter Sections</h6>
                        <div class="search-row">
                            <input type="number" id="sectionMinEntropy" placeholder="Min entropy" step="0.1" min="0" max="8" style="width:120px;">
                            <input type="text" id="sectionPermissions" placeholder="Perms (RWX)" style="width:100px;">
                            <label class="d-flex align-items-center gap-2"><input type="checkbox" id="sectionSuspiciousOnly"> Suspicious only</label>
                            <button class="btn btn-primary btn-sm" id="filterSectionsBtn"><i class="fas fa-filter me-1"></i>Filter</button>
                        </div>
                        <div id="sectionResults" class="mt-3"></div>
                    </div>

                    <div class="adv-panel" id="panelIocs">
                        <h6><i class="fas fa-crosshairs me-2"></i>Extract IOCs</h6>
                        <p class="text-muted small mb-3">Extract URLs, IPs, domains, file paths, registry keys.</p>
                        <button class="btn btn-warning btn-sm" id="extractIocsBtn"><i class="fas fa-download me-1"></i>Extract All IOCs</button>
                        <div id="iocResults" class="mt-3"></div>
                    </div>

                    <div class="adv-panel" id="panelHex">
                        <h6><i class="fas fa-th me-2"></i>Hex Dump</h6>
                        <div class="search-row">
                            <select id="hexSection" style="width:140px;"><option value="">-- Section --</option></select>
                            <span class="text-muted">or</span>
                            <input type="number" id="hexOffset" placeholder="Offset" style="width:100px;">
                            <input type="number" id="hexLength" value="256" min="16" max="4096" style="width:80px;" title="Bytes">
                            <button class="btn btn-primary btn-sm" id="getHexdumpBtn"><i class="fas fa-eye me-1"></i>View</button>
                        </div>
                        <div id="hexResults" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-lg-6"><div class="card"><div class="card-header">Section Sizes</div><div class="card-body"><canvas id="sectionChart"></canvas></div></div></div>
                <div class="col-lg-6"><div class="card"><div class="card-header">Section Entropy</div><div class="card-body"><canvas id="entropyChart"></canvas></div></div></div>
            </div>

            <div class="card"><div class="card-header">Entropy Heatmap</div><div class="card-body"><div id="heatmapPlot" style="height:250px;"></div></div></div>

            <!-- Section Table -->
            <div class="card">
                <div class="card-header">Section Analysis</div>
                <div class="table-responsive">
                    <table class="table section-table mb-0">
                        <thead><tr><th>Section</th><th>Entropy</th><th>Ratio</th><th>Perms</th><th>Score</th><th>Level</th></tr></thead>
                        <tbody id="sectionTableBody"><tr><td colspan="6" class="text-center py-4 text-muted">Awaiting analysis...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Attribution & Capabilities -->
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">Threat Attribution</div><div class="card-body"><canvas id="attributionRadar"></canvas></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">Capabilities</div><div class="card-body" id="capabilitiesContainer"><p class="text-muted">No analysis yet.</p></div></div></div>
            </div>

            <!-- MITRE -->
            <div class="card"><div class="card-header d-flex justify-content-between"><span>MITRE ATT&CK</span><span class="badge bg-danger" id="mitreBadge">0</span></div><div class="card-body" id="mitreMatrix"><p class="text-muted">No techniques detected.</p></div></div>

            <!-- Verdict -->
            <div class="card"><div class="card-header">Verdict</div><div class="card-body" id="verdictContainer"><p class="text-muted">Awaiting analysis...</p></div></div>

            <!-- Console -->
            <div class="card"><div class="card-header">Console</div><div class="card-body p-0"><div id="analysisLog"><div style="color:#17a2b8;">> System ready. Upload a file to begin.</div></div></div></div>

            <!-- Actions -->
            <div class="d-flex justify-content-center gap-3 my-4 flex-wrap">
                <button class="btn btn-primary" id="downloadPdfBtn" style="display:none;"><i class="fas fa-file-pdf me-2"></i>Download PDF Report</button>
                <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fas fa-print me-2"></i>Print</button>
                <button class="btn btn-outline-secondary" onclick="location.reload()"><i class="fas fa-redo me-2"></i>New Analysis</button>
            </div>
        </div>
    </div>

    <footer class="py-4 text-center text-muted small">
        <div class="container">
            <p class="mb-1 fw-medium">PE-SENTINEL</p>
            <p class="opacity-50 mb-2">Static Malware Analysis • 2026</p>
            <div class="d-flex justify-content-center gap-3">
                <a href="/home">Home</a>
                <a href="/docs">Documentation</a>
                <a href="https://github.com/yourusername/pe-sentinel"><i class="fab fa-github me-1"></i>GitHub</a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dark mode toggle
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            
            const icon = document.getElementById('themeIcon');
            icon.className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Update charts if they exist
            updateChartsTheme(next);
        }
        
        // Load saved theme
        (function() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            const icon = document.getElementById('themeIcon');
            if (icon) icon.className = saved === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        })();
        
        function updateChartsTheme(theme) {
            const textColor = theme === 'dark' ? '#f1f5f9' : '#1e293b';
            const gridColor = theme === 'dark' ? '#334155' : '#e2e8f0';
            
            // Update Chart.js defaults for new charts
            if (typeof Chart !== 'undefined') {
                Chart.defaults.color = textColor;
                Chart.defaults.borderColor = gridColor;
            }
        }
    </script>
    <script src="js/main.js"></script>
</body>
</html>